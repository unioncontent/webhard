<div class="main-body">
  <div class="page-wrapper">
    <div class="page-header">
      <div class="page-header-title">
        <h4>키워드설정</h4>
      </div>
      <div class="page-header-breadcrumb">
        <ul class="breadcrumb-title">
          <li class="breadcrumb-item">
            <a href="/">
              <i class="icofont icofont-home"></i>
            </a>
          </li>
          <li class="breadcrumb-item"><a href="#!">콘텐츠관리</a></li>
          <li class="breadcrumb-item"><a href="#!">키워드설정</a></li>
        </ul>
      </div>
      <div class="page-body">
        <div class="row">
        </div>
      </div>
    </div>
    <div class="page-body">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <h5>키워드등록</h5>
              <span>* 항목은 필수 입력입니다.</span>
              <div class="card-header-right">
                  <i class="icofont icofont-rounded-down"></i>
              </div>
            </div>
            <div class="card-block">
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">* 콘텐츠</label>
                <div class="col-sm-5">
                  <input name="cp_name" type="hidden" class="form-control">
                  <input name="contentsID" type="hidden" class="form-control">
                  <input name="cnt_name" type="text" class="form-control" id="cnt_name" placeholder="콘텐츠명">
                    <span class="messages"><p class="text-danger error"></p></span>
                  <span class="messages"><p class="text-danger error"></p></span>
                </div>
                <div class="col-sm-1 btn-check">
                  <button id="contentsBtn" type="button" class="btn btn-inverse alert-prompt">검색</button>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">상태</label>
                <div class="col-sm-5">
                  <div class="form-radio">
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="1" name="k_key">
                        <i class="helper"></i>ON
                      </label>
                    </div>
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="0" name="k_key">
                        <i class="helper"></i>OFF
                      </label>
                    </div>
                  </div>
                  <input name="oK_key" type="hidden" class="form-control">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">관리방법</label>
                <div class="col-sm-5">
                  <div class="form-radio">
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="1" name="k_method">
                        <i class="helper"></i>자동
                      </label>
                    </div>
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="0" name="k_method">
                        <i class="helper"></i>수동
                      </label>
                    </div>
                  </div>
                  <input name="oK_method" type="hidden" class="form-control">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">관리현황</label>
                <div class="col-sm-5">
                  <div class="form-radio">
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="D" name="k_apply">
                        <i class="helper"></i>삭제
                      </label>
                    </div>
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="T" name="k_apply">
                        <i class="helper"></i>제휴
                      </label>
                    </div>
                    <div class="radio radio-inline">
                      <label>
                        <input type="radio" value="P" name="k_apply">
                        <i class="helper"></i>보류
                      </label>
                    </div>
                  </div>
                  <input name="oK_apply" type="hidden" class="form-control">
                </div>
              </div>
              <div class="row">
                  <label class="col-sm-2"></label>
                  <div class="col-sm-10">
                      <button id="updateBtn" type="submit" class="btn btn-primary m-b-0">수정</button>
                  </div>
                </div>
            </div>
          </div>
          <div class="card" id="keywordList" style="display: none;">
            <div class="card-header">
              <h5>키워드 리스트 - <h5 id="cnt_title"></h5></h5>
            </div>
            <div class="card-block table-border-style">
              <div class="table-responsive">
                <table class="table table-columned table-striped">
                  <thead>
                    <tr>
                      <th></th>
                      <th>검색어</th>
                      <th>제외검색어</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr id='inputKey'>
                      <th scope="row" class="centerTh">입력</th>
                      <td>
                        <input type="text" class="form-control" id="pSearch">
                        <span class="messages"><p class="text-danger error m-b-0"></p></span>
                      </td>
                      <td>
                        <input type="text" class="form-control" id="dSearch">
                        <span class="messages"><p class="text-danger error m-b-0"></p></span>
                      </td>
                      <td><button class="btn btn-success btn-sm" id="insertKeywordBtn"><i class="icofont icofont-plus" style="margin-right:0"></i></button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal start-->
      <div class='modal fade' id='keyword-Modal' role='dialog'>
        <div class='modal-dialog' role='document'>
          <div class='modal-content'>
            <div class='modal-header'>
              <h5 class="modal-title">콘텐츠 검색</h5>
            </div>
            <div class='modal-body'>
              <div class='card'>
                <div class="card-block table-border-style">
                  <div class="table-responsive">
                    <table class="table table-columned table-striped">
                      <thead>
                        <tr>
                          <th>
                            <input type="text" class="form-control" id="search_cnt_name" placeholder="콘텐츠명">
                          </th>
                          <th width="1px">
                            <button type="button" id="btn-searchCnt" class="btn btn-inverse alert-prompt">검색</button>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                      <tfoot>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary mobtn" data-dismiss='modal' aria-label='Close' type="button">취소</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal end-->
    </div>
  </div>
</div>
<style type="text/css">
.contents{
  font-size: 15px;
  padding-left: 3px;
  text-overflow: ellipsis;
  width: 332px;
  overflow: hidden;
}
#keyword-Modal .modal-body{
  overflow: auto;
  max-height: 546px;
}

</style>
<script type="text/javascript">
$('#search_cnt_name').on('keyup',function(event){
  if(event.keyCode == 13){
    $('#btn-searchCnt').trigger('click');
  };
});

$("#contentsBtn").on("click",function(){
  $("#search_cnt_name").val($("#cnt_name").val());
  searchCnt($("#search_cnt_name").val());
  $("#keyword-Modal").modal('show');
});

$("#btn-searchCnt").on("click",function(){
  searchCnt($("#search_cnt_name").val());
});

$(document).on("click",".btn-cnt",function(event){
  var title = $(event.target).parents("tr").find(".contents").text().split(" : ")[1];
  var idx = $(event.target).parents("tr").find(".n_idx_c").val();
  $("#keyword-Modal tbody").empty();
  $("#keyword-Modal").modal('hide');
  $("#keyword-Modal tbody").empty();
  $("#search_cnt_name").val("");
  $("input[name=contentsID]").val(idx);
  $("#cnt_title").text(title);
  $("#cnt_name").val(title);
  openKeywordList(idx);
});

$("input[name=k_method]").on('change',function(){
  console.log(this.value);
  if(this.value == 0){
    $("input[name=k_apply]:input[value=P]").click();
    $("input[name=k_apply]").attr("disabled",true);
  }
  else if(this.value == 1){
    $("input[name=k_apply]").attr("disabled",false);
  }
});

$("#updateBtn").on('click',function(event){
  $.ajax({
    url: '../contents/update',
    type: 'post',
    data: {
      'K_method': $('input:radio[name=k_method]:checked').val(),
      'K_key': $('input:radio[name=k_key]:checked').val(),
      'K_apply': $('input:radio[name=k_apply]:checked').val(),
      'n_idx_c': $('input[name=contentsID]').val(),
      'type': 'all'
    },
    error:function(request,status,error){
      alert("다시시도해주세요.");
      console.log('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
    },
    success:function(data){
      if(data){
        alert("수정완료되었습니다.");
      }
    }
  });
});

$("#insertKeywordBtn").on("click",function(){
  $.ajax({
    url: '../keyword/add',
    type: 'post',
    data: {
      'keyword': [$('#pSearch').val(),$('#dSearch').val()],
      'n_idx_c': $('input[name=contentsID]').val(),
      'K_key': $("input[name ='oK_key']").val(),
      'K_method': $("input[name ='oK_method']").val(),
      'K_apply': $("input[name ='oK_apply']").val(),
      'U_id_c': $("input[name ='cp_name']").val(),
    },
    error:function(request,status,error){
      alert("다시시도해주세요.");
      console.log('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
    },
    success:function(data){
      if(data){
        alert("추가되었습니다.");
        $('#pSearch').val("");
        $('#dSearch').val("");
        openKeywordList(data.n_idx_c);
      }
    }
  });
});

$(document).on("click",".remove_keyword",function(){
  var idx = $(this).parents("tr").find(".n_idx_k").val();
  $.ajax({
    url: '../keyword/delete',
    type: 'post',
    data: {
      'n_idx': idx
    },
    error:function(request,status,error){
      alert("다시시도해주세요.");
      console.log('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
    },
    success:function(data){
      if(data){
        openKeywordList($("input[name=contentsID]").val());
      }
      else{
        alert("다시시도해주세요.");
      }
    }
  });
});

function openKeywordList(idx){
  $.ajax({
    url: '../keyword/searchKeyInfo',
    type: 'post',
    data : {'n_idx_c': idx},
    datatype : 'json',
    error:function(request,status,error){
      // alert('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
      alert(request.responseText);
    },
    success:function(data){
      $("tbody tr:not(#inputKey)").remove();
      data.forEach(function(item, idx){
        if(idx == 0){
          $("input[name ='oK_key']").val(item.K_key);
          $("input[name ='oK_method']").val(item.K_method);
          $("input[name ='oK_apply']").val(item.K_apply);
          $("input[name ='cp_name']").val(item.U_id_c);

          $("input:radio[name ='k_key']:input[value='"+item.K_key+"']").attr("checked", true);
          $("input:radio[name ='k_method']:input[value='"+item.K_method+"']").attr("checked", true);
          $("input:radio[name ='k_apply']:input[value='"+item.K_apply+"']").attr("checked", true);
        }
        var html = '<tr><th scope="row" class="centerTh">'+(idx+1)+'</th>';
        if(item.K_type != '0'){
          html += '<td><div class="keyword">'+item.K_keyword+'</div><input type="hidden" class="n_idx_k" value="'+item.n_idx+'"/></td><td></td>';
        }
        else{
          html += '<td></td><td><div class="keyword">'+item.K_keyword+'</div><input type="hidden" class="n_idx_k" value="'+item.n_idx+'"/></td>';
        }
        html += '<td><button class="remove_keyword btn btn-danger btn-sm"><i class="icofont icofont-garbage" style="margin-right:0"></i></button></td></tr>';
        $("#inputKey").after(html);
      });
      console.log("data : ",data);
      $("#keywordList").show();
    }
  });
}
function searchCnt(name){
  if($('#search_cnt_name').val() == ""){
    alert("검색어를 넣어주세요.");
    return false;
  }
  $.ajax({
    url: '../keyword/searchCnt',
    type: 'post',
    data : {
      'CP_title': $('#search_cnt_name').val()
    },
    datatype : 'json',
    error:function(request,status,error){
      // alert('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
      alert(request.responseText);
    },
    success:function(data){
      $("#keyword-Modal tbody").empty();
      console.log(data);
      data.forEach(function(item){
        var html = '<tr><td style="vertical-align: middle;"><div class="contents">'+item.CP_name+' : '+item.CP_title+'('+item.CP_cntID+')</div>\
        <input type="hidden" class="n_idx_c" value="'+item.n_idx_c+'"></td>\
        <td><button type="submit" class="btn-cnt btn btn-primary m-b-0">선택</button></td></tr>'
        $("#keyword-Modal tbody").append(html);
      });
    }
  });
}

</script>
