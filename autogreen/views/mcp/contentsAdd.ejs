<div class="main-body">
  <div class="page-wrapper">
    <div class="page-header">
      <div class="page-header-title">
        <h4>콘텐츠등록</h4>
      </div>
      <div class="page-header-breadcrumb">
        <ul class="breadcrumb-title">
          <li class="breadcrumb-item">
            <a href="/">
              <i class="fas fa-home"></i>
            </a>
          </li>
          <li class="breadcrumb-item"><a href="#!">콘텐츠관리</a></li>
          <li class="breadcrumb-item"><a href="/contents/add">콘텐츠등록</a></li>
        </ul>
      </div>
    </div>
    <div class="page-body">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-block">
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 관리사(MCP)</label>
                <div class="col-sm-9">
                  <select name="select" class="form-control" id="selectMCP">
                    <% for(var i=0; i < mcpList.length; i++) {%>
                      <option value="<%=mcpList[i].cp_id%>"><%=mcpList[i].cp_cname%></option>
                    <% }; %>
                  </select>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 저작권사(CP)</label>
                <div class="col-sm-9">
                  <select name="select" class="form-control" id="selectCP">
                    <% for(var i=0; i < cpList.length; i++) {%>
                      <option value="<%=cpList[i].cp_id%>"><%=cpList[i].cp_cname%></option>
                    <% }; %>
                  </select>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 제목</label>
                <div class="col-sm-9">
                  <input id="cnt_title" type="text" class="form-control" placeholder="제목">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">영문제목</label>
                <div class="col-sm-9">
                  <input id="cnt_title_eng" type="text" class="form-control" placeholder="영문제목">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">제작/감독</label>
                <div class="col-sm-9">
                  <input id="cnt_director" type="text" class="form-control" placeholder="동명 제목의 영화나 방송물을 구분을 위한 키">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">제작국가</label>
                <div class="col-sm-9">
                  <select name="select" class="form-control" id="selectNat">
                    <%
                    for(var i=0; i < country.length; i++) {
                      var str = country[i].replace('\r','');
                    %>
                      <option value="<%=str%>" <%=((str == '한국')?'selected':'')%>><%=str%></option>
                    <% }; %>
                  </select>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">카테고리</label>
                <div class="col-sm-9">
                  <select name="select" class="form-control" id="selectCate">
                    <option value="0">미분류</option>
                    <option value="1">영화</option>
                    <option value="2">드라마</option>
                    <option value="3">방송</option>
                    <option value="4">음악</option>
                    <option value="5">문서</option>
                    <option value="6">이미지</option>
                  </select>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">CPID</label>
                <div class="col-sm-9">
                  <input id="cnt_cpid" type="text" class="form-control" placeholder="CP사에서 정한 콘텐츠ID">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">저작권만료기간</label>
                <div class="col-sm-9">
                  <input id="cnt_period" type="text" class="form-control" value="2999-12-31"/>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 관리현황</label>
                <div class="col-sm-9">
                  <div id="state" class="form-radio">
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="1" name="k_state">
                        <i class="helper"></i>관리중
                      </label>
                    </div>
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="0" name="k_state" checked>
                        <i class="helper"></i>중단
                      </label>
                    </div>
                  </div>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 관리상태</label>
                <div class="col-sm-9">
                  <div id="apply" class="form-radio">
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="D" name="k_apply">
                        <i class="helper"></i>삭제/차단요청
                      </label>
                    </div>
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="T" name="k_apply">
                        <i class="helper"></i>제휴전환요청
                      </label>
                    </div>
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="C" name="k_apply">
                        <i class="helper"></i>채증
                      </label>
                    </div>
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="L" name="k_apply" checked>
                        <i class="helper"></i>보류
                      </label>
                    </div>
                  </div>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 메일발송</label>
                <div class="col-sm-9">
                  <div id="mailing" class="form-radio">
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="1" name="k_mailing">
                        <i class="helper"></i>발송
                      </label>
                    </div>
                    <div class="radio radiofill radio-inverse radio-inline">
                      <label>
                        <input type="radio" value="0" name="k_mailing" checked>
                        <i class="helper"></i>발송안함
                      </label>
                    </div>
                  </div>
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">* 판매금액</label>
                <div class="col-sm-9">
                  <input id="cnt_price" type="number" class="form-control" placeholder="0">
                  <span class='messages'><p class='text-danger error'></p></span>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">HASH 값</label>
                <div class="col-sm-9">
                  <input id="cnt_hash" type="text" class="form-control">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">뮤레카 HASH값</label>
                <div class="col-sm-9">
                  <input id="cnt_mureka" type="text" class="form-control">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">아컴스튜디오 HASH값</label>
                <div class="col-sm-9">
                  <input id="cnt_acom" type="text" class="form-control">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-3 col-form-label">기본키워드</label>
                <div class="col-sm-9">
                  <input id="k_title" type="text" class="form-control">
                </div>
              </div>
              <div class="row">
                <div class="col-sm-12">
                  <button id="insertBtn" type="submit" class="f-right btn btn-inverse m-b-0">등록</button>
                  <button id="excelBtn" type="submit" class="f-right m-r-10 btn btn-primary m-b-0"><i class="fas fa-file-excel"></i>엑셀대량등록</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal start-->
      <div class="modal fade" id="cnt-Modal" data-backdrop="static" data-keyboard="false" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">엑셀대량등록</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">×</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="col-lg-12">
                <div class="inline-order-list m-t-0">
                  <h4 class="sub-title">example</h4>
                  <p class="text-muted">
                    ※ 엑셀 1행 생략불가, method값 = 자동:1/수동:0 , apply값 = 삭제:D/제휴:T/보류:P
                  </p>
                </div>
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr class="text-uppercase border-bottom-inverse">
                        <th class="text-center">#</th>
                        <th class="text-center">A</th>
                        <th class="text-center">B</th>
                        <th class="text-center">C</th>
                        <th class="text-center">D</th>
                        <th class="text-center">E</th>
                        <th class="text-center">F</th>
                        <th class="text-center">G</th>
                        <th class="text-center">H</th>
                        <th class="text-center">I</th>
                      </tr>
                    </thead>
                    <tbody class="text-center">
                      <tr class="table-danger border-bottom-inverse">
                        <th scope="row">1</th>
                        <td>cpId</td>
                        <td>title</td>
                        <td>engtitle</td>
                        <td>ospid</td>
                        <td>method</td>
                        <td>apply</td>
                        <td>hash</td>
                        <td>price</td>
                        <td>keyword</td>
                      </tr>
                      <tr class="border-bottom-inverse">
                        <th>2</th>
                        <td>MBC</td>
                        <td>무도</td>
                        <td class="text-muted">IC<br>(생략가능)</td>
                        <td>fileham</td>
                        <td>0</td>
                        <td>P</td>
                        <td class="text-muted">sd###<br>(생략가능)</td>
                        <td class="text-muted">10000<br>(생략가능)</td>
                        <td class="text-muted">무한도전<br>(생략가능)</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-lg-12">
                <h4 class="sub-title m-b-10">upload</h4>
                  <div class="form-group row">
                    <div class="col-sm-10">
                      <form action="/cnts/add/upload" id="uploadFrm" method="post" enctype="multipart/form-data">
                        <input type="file" id="excel" name="excel" accept=".xls,.xlsx" class="form-control">
                      </form>
                    </div>
                    <div class="col-sm-2">
                    </div>
                  </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default waves-effect " data-dismiss="modal">취소</button>
              <button id="insertBtn2" class="btn btn-inverse">등록</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal end-->
    </div>
  </div>
</div>
<style type="text/css">
table.table-columned th, table.table-columned td,
.table td, .table th{
  border: 1px solid #34495e;
}
</style>
<!-- Bootstrap daterangepicker js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.27/daterangepicker.css" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.27/moment.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.27/daterangepicker.js"></script>
<!-- alert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert@2.1.0/dist/sweetalert.min.js"></script>
<script>
  $(document).ready(function(){
    var url = new URL(window.location.href);
    var msg = url.searchParams.get("msg");
    var upload = url.searchParams.get("upload");
    var excelNum = 0;
    if(upload || msg){
      history.pushState(null, null,location.href.split('?')[0]);
    }
    if(upload == 'true'){
      alert('일괄등록 성공했습니다.');
    }
    else if(upload == 'false'){
      console.log(msg);
      if(msg){
        excelNum = String(Number(msg.split('_')[0])+1);
        msg = msg.split('_')[1];
      }
      var errorMsg = '일괄등록 실패했습니다.\n';
      if(msg == 'ExcelHeaderError'){
        errorMsg += '엑셀 1열에 내용이 틀렸습니다.\n다시 확인해주세요.';
      }
      else if(msg == 'OSPIdError'){
        errorMsg += 'OSP ID가 맞는지 다시 확인해주세요.';
      }
      else if(msg == 'CPNameError'){
        errorMsg += 'CP사 이름이 등록이 되어있는지 확인해주세요.\n엑셀 '+excelNum+'번줄을 확인해주세요.';
      }
      else if(msg == 'NoFileError'){
        errorMsg += '해당 파일의 상태를 확인해주세요.';
      }
      else if(msg == 'ExcelSysError'){
        errorMsg += '시스템에 문제가 생겼습니다.\n나중에 다시 시도해주세요.';
      }
      else{
        errorMsg += '다시 시도해주세요.';
      }
      alert(errorMsg);
    }
  });
  // 등록버튼 클릭시
  $("#insertBtn").on("click",function(){
    swal({
      title: "등록하시겠습니까?",
      icon: "warning",
      buttons: ["취소", true],
      dangerMode: true
    })
    .then(function(value) {
      if (value != null) {
        insertContents();
      }
    });
  });
  // 등록 ajax func
  function insertContents(){
    var check=false;
    var param = {
      cnt_mcp:$("#selectMCP option:selected").val(),
      cnt_cp:$("#selectCP option:selected").val(),
      cnt_title:$("#cnt_title").val(),
      cnt_price:$("#cnt_price").val(),
      k_title:($("#k_title").val() != "") ? $("#k_title").val():$("#cnt_title").val(),
      k_state:$("input:radio[name='k_state']:checked").val(),
      k_apply:$("input:radio[name='k_apply']:checked").val(),
      k_mailing:$("input:radio[name='k_mailing']:checked").val()
    };
    // 필수
    if(param.cnt_title == ""){
      check = requiredMessage("cnt_title","제목을 선택해주세요.");
    }
    if(param.cnt_price == ""){
      check = requiredMessage("cnt_price","판매금액을 선택해주세요.");
    }
    if(check){
      return false;
    }

    // 추가
    if($("#cnt_eng_title").val() != ""){
      param.cnt_eng_title = $("#cnt_eng_title").val();
    }
    if($("#cnt_director").val() != ""){
      param.cnt_director = $("#cnt_director").val();
    }
    if($("#cnt_nat option:selected").val() != ""){
      param.cnt_nat = $("#cnt_nat option:selected").val();
    }
    if($("#cnt_cate option:selected").val() != ""){
      param.cnt_cate = $("#cnt_cate option:selected").val();
    }
    if($("#cnt_cpid").val() != ""){
      param.cnt_cpid = $("#cnt_cpid").val();
    }
    if($("#cnt_period").val() != ""){
      param.cnt_period = $("#cnt_period").val();
    }
    if($("#cnt_hash").val() != ""){
      param.cnt_hash = $("#cnt_hash").val();
    }
    if($("#cnt_mureka").val() != ""){
      param.cnt_mureka = $("#cnt_mureka").val();
    }
    if($("#cnt_acom").val() != ""){
      param.cnt_acom = $("#cnt_acom").val();
    }

    $.ajax({
      url: '/cnts/add',
      type: 'post',
      data : param,
      datatype : 'json',
      error:function(request,status,error){
        console.log('code:'+request.status+'\n'+'message:'+request.responseText+'\n'+'error:'+error);
        alert(request.responseText);
        location.reload();
      },
      success:function(data){
        alert('등록되었습니다.');
        location.reload();
      }
    });
  }

  $("input, select").on("focus",function(){
    $(this).removeClass("form-control-danger");
    $(this).siblings().children("p").text("");
  });

  function requiredMessage(target,msg){
    $("#"+target).siblings().children().text(msg);
    $("#"+target).addClass("form-control-danger");
    return true;
  }

  // 엑셀 대량 등록
  $('#excelBtn').on('click',function(){
    $('#cnt-Modal').modal('show');
  });

  $('#insertBtn2').on('click',function(){
    swal({
      title: "대량등록하시겠습니까?",
      icon: "warning",
      buttons: ["취소", true],
      dangerMode: true
    })
    .then(function(value) {
      if (value != null) {
        if($('input[type=file]').val()==""){
          alert('파일을 선택해주세요.');
          return false;
        }
        $("#uploadFrm").submit();
      }
    });
  });

  // 저작권만료기간
  $('#cnt_period').daterangepicker({
    singleDatePicker: true,
    showDropdowns: true,
    locale: {
      format: 'YYYY-MM-DD',
      "customRangeLabel": "Custom",
      "daysOfWeek": [
          "일", "월", "화", "수", "목", "금", "토"
      ],
      "monthNames": [
        "1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"
      ],
    }
  });
</script>
